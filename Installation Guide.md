# Currently Running on Ubuntu 24.04, this may change in the future as CrowdStrike changes their guidelines for compliance

## Setup on a new Virtual Machine

### Please Note: This document is only for setting up on a new VM. Please do not run the following steps if website is already configured.

- [ ] Install Apache2 via apt

- [ ] Install sqlite3 and mysql2 via apt

- [ ] Install Ruby and RubyGems via apt

- [ ] `gem install rails`

- [ ] Navigate to /var/www/[your_application] then run: `rails new server`

- [ ] Edit Gemfile to include `rails, hike, authlogic, sqlite3, mysql2 and passenger`

- [ ] `bundle install` to download gems

- [ ] Replace generated `/public` and `/app` folders with the one's provided in this folder

- [ ] Grep for `[FOR NEW ADMIN]` and make changes as recommended in comments

- [ ] By this point, the park of NanoSpace should be available upon starting the Apache2 server. However, none of the games or login/signup will work or display, as they require at least a (nonfunctional) database that they can read to be able to start. This may change in the future if our code changes.

- [ ] Set up an account and production database for mysql2

- [ ] Set up Phusion Passenger

- [ ] Add the following to `/config/routes.rb`:
```ruby
get '/logged_in',     to: 'user_sessions#logged_in'
post '/login',        to: 'user_sessions#create'
delete '/logout',     to: 'user_sessions#destroy'
```

- [ ] Check old ruby files within the server/apps folder if changed between major versions of Ruby. There may be depricated code which needs to be changed. For example, if setting up off of the original 2013 NanoSpace, all of the before_filters need to be changed to before_actions, since they changed the names of the functions

- [ ] Setup database.yml, storage.yml, credentials.yml, master.key and any other files which may have errors. Error logs should be contained within Passenger's error log, the production.log file and on certain webpages such as nanotoon.cs.rpi.edu/logged_in#
If porting from our new VM, should be able to skip this step unless we have updated between big versions of Ruby or Rails.

- [ ] At this point, everything except for the database to login/signup and save scores should be working once you start up the server.

- [ ] It is heavily recommended that once you have a URL for your site that you upgrade to HTTPS, as otherwise user passwords are sent in the clear. This is done by adding appropriate SSL certificates to the Apache2 config folder and adding the appropriate modifications to the Apache2 site config file (e.g. change to port 443, add `SSL Engine On`, add the paths to the SSL certificates, etc.) If your URL is controlled by your instituion, you may have to work with your IT department or the relevant sysadmin to have appropriate SSL certificates issued.

### Realistically, it may be easier to setup with an entirely new VM without any of the Ruby code at first. This is because performing setup with rails should autogenerate quite a few files. Rather than sift through many of our possibly outdated autogenerated Ruby files, it may be smarter and faster to autogenerate up-to-date files, which could lead to less technical headaches down the line. Setup should still start the same way. Get everything above downloaded using apt or RubyGems with bundler and a Gemfile. Then begin setup and copy and paste the manually written Ruby files from the old server to the new one.


## Old installation guide below which may contain more details but is also worse formatted below

1. Install Apache 2 via
> sudo apt install apache2
2. Install sqlite3 and mysql2 via
> sudo apt-get install mysql-server
> 
> sudo apt install sqlite3
3. Install Ruby and RubyGems via
> sudo apt-get install ruby-full
4. Install necessary Ruby Gems via gem
> rails
>
> hike
>
> authlogic
>
> sqlite3
>
> mysql2
>
> passenger
5. Set up mysql database
> 
6. Copy over all files in a folder called /www/ under /var/

7. Setup Passenger
> https://www.phusionpassenger.com/docs/tutorials/deploy_to_production/deploying_your_app/enterprise/aws/ruby/standalone/
> Added `<VirtualHost *:80>
    ServerName 128.113.126.65

    # Tell Apache and Passenger where your app's 'public' directory is
    DocumentRoot /var/www/nanospace/server/public

    PassengerRuby /usr/local/bin/ruby

    # Relax Apache security settings
    <Directory /var/www/nanospace/server/public>
      Allow from all
      Options -MultiViews
      # Uncomment this if you're on Apache > 2.4:
      Require all granted
    </Directory>
</VirtualHost>`

8. Fix issues according to Passenger's error log file, more information in error_log.md
> /var/log/apache2/error.log
> 
~~Adding active storage according to https://edgeguides.rubyonrails.org/active_storage_overview.html and https://guides.rubyonrails.org/active_storage_overview.html~~
Removed Active Storage usage in Rails, must be removed or used between the updates between Rails 5 and Rails 6.

`fixed`

~~Fixing Secret Key in Production error, no secrets.yml file available in config. This is required by Rails 4.~~ secrets.yml is replaced by credentials.yml.enc and master.key in Rails 7. Follow https://blog.assistancy.be/blog/how-to-store-credentials-in-rails-7/.

`fixed`

9. Now using production.log to fix errors in /var/www/nanospace/server/log/production.log

Error lies within database.yml, changed username and password for mysql to be the root account and its password

`fixed`

10. At this point, LOGIN and SIGN UP should appear as options on the homepage, and the games should be playable. However, signup and login doesn't work.

`Currently in progress`
